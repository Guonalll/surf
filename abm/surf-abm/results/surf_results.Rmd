---
title: "surf results analysis"
author: "Nick Malleson"
date: '`r format(Sys.time(), "%d %B, %Y (%H:%M)")`'
output:
  html_document: 
    toc: yes
    pandoc_args: [
      "+RTS", "-K64m",
      "-RTS"
    ]
  pdf_document:
    fig_crop: no
    highlight: kate
    keep_tex: yes
    latex_engine: xelatex
    number_sections: yes
fontsize: 10pt
---

```{r initialise, echo=FALSE, message=FALSE, warning=FALSE}

SCENARIO <- "ABBF-easel" # The name of the scenario to analyse
AGENT_ID <- 508 # The ID of the agent to analyse (graphs of all agents can be difficult to undersatnd.)


# Find the most recent run of that scenario
#scenarios.dir <- paste("~/research_not_syncd/git_projects/surf/abm/surf-abm/results/out/",SCENARIO,"/",sep="")
scenario.dir <- paste("./out/",SCENARIO,"/",sep="") # This is the relative directory of the scenario 
setwd("~/research_not_syncd/git_projects/surf/abm/surf-abm/results/") # This is only required when running directly in R(Studio)
runs <- sort(list.files(scenario.dir)) # All the different runs (directories)
run <- tail(runs, n=1) # Most recent run/scenario
wd <- paste(scenario.dir, run, "/", sep="") # The new working directory
print(paste("Using working directory of most recent model of type",SCENARIO,":",wd))
#setwd(wd)


library(GISTools)
#library(rgeos)    # For things like gIntersects
#library(rgdal)     # For reading shapefiles
#library(raster)    # For creating regular grids
#library(plyr)     # For counting and aggregating
#library(tmap)     # For thematic maps
#library(classInt) # Jenks natural breaks
#library(png)      # For loading pngs after they have been written
#library(grid)     # so that they can be embedded in knitted documents
#library(spdep)    # For doing the spatial regression, contiguity matrices, etc.
#library(GWmodel)  # For geographically weighted regression (GWR)
#library(MASS)     # For stepwise regression (stepAIC())
#library(pander)   # For printing tables nicely
#library(MVN)      # For testing for multivariate normality (MVN)

```

# Results anlysis of scenario `r SCENARIO`, run `r run`

Read the data on the agent locations and the activities of the agents at each timestep


```{r readData}
agents <- read.csv(paste(wd,'agents.csv',sep=""))
acts <- read.csv(paste(wd,'agent-activities.csv',sep=""))

# Make proper time columns. Text format is "2011-01-01T01:10"

agents$date <- strptime(as.character(agents$Time), "%Y-%m-%dT%H:%M")
acts$date <- strptime(as.character(acts$Time), "%Y-%m-%dT%H:%M")
```


Plot just the overall intensities of the different activities.

```{r plotOverallActivity}

# Find the activity with the highest overall intensity. That needs to be plotted first
all.acts <- unique(acts$Activity)

# Plot
par(mfrow=c(1,1))
i <- 1 # For colours
for (activity in all.acts) {
  if (i==1) { # First plot
    # Plot overall intensity
    plot(x=acts[which(acts$Activity==activity & acts$Agent==AGENT_ID),]$date,
         y=acts[which(acts$Activity==activity & acts$Agent==AGENT_ID),]$Intensity, 
         type='o', col=i, ylim=c(0,max(acts$Intensity)), pch=1,
         xlab = "Time", ylab="TotalIntensity", main=paste("Activities for agent",AGENT_ID))
  } else { # Now for the remaining activities
    points(
      x=acts[which(acts$Activity==activity & acts$Agent==AGENT_ID),]$date, 
      y=acts[which(acts$Activity==activity & acts$Agent==AGENT_ID),]$Intensity, type='o', col=i )
  }
  i <- i + 1 # increment the colour counter (one colour per activity)
  j<- 1 # Reset the point type counter - same point type for each kind of intensity (total, background, time)
}

legend("topleft", legend=all.acts, col=1:length(all.acts), lty=1, pch="o")


```


Plot all the intensities of the different activities in one chart.

```{r plotActivitiesInOne}

# Find the activity with the highest overall intensity. That needs to be plotted first
all.acts <- unique(acts$Activity)

# Plot
i <- 1 # For colours
for (activity in all.acts) {
  if (i==1) { # First plot
    # Plot overall intensity
    plot(x=acts[which(acts$Activity==activity & acts$Agent==AGENT_ID),]$date,
         y=acts[which(acts$Activity==activity & acts$Agent==AGENT_ID),]$Intensity,
         type='o', col=i, ylim=c(0,max(acts$Intensity)), pch=1,
         xlab = "Time", ylab="TotalIntensity", main=paste("Intensities for agent",AGENT_ID))
    # Backgruound intesity
    points(
      x=acts[which(acts$Activity==activity & acts$Agent==AGENT_ID),]$date,
      y=acts[which(acts$Activity==activity & acts$Agent==AGENT_ID),]$BackgroundIntensity, 
      type='o', col=i, pch=2)
    # Time intensity
    points(
      x=acts[which(acts$Activity==activity & acts$Agent==AGENT_ID),]$date,
      y=acts[which(acts$Activity==activity & acts$Agent==AGENT_ID),]$TimeIntensity, 
      type='o', col=i, pch=3)
  } else { # Now for the remaining activities
    points(x=acts[which(acts$Activity==activity & acts$Agent==AGENT_ID),]$date,y=acts[which(acts$Activity==activity & acts$Agent==AGENT_ID),]$Intensity, , type='o', col=i, pch=1)
    points(x=acts[which(acts$Activity==activity & acts$Agent==AGENT_ID),]$date, y=acts[which(acts$Activity==activity & acts$Agent==AGENT_ID),]$BackgroundIntensity, type='o', col=i, pch=2)
    points(x=acts[which(acts$Activity==activity & acts$Agent==AGENT_ID),]$date, y=acts[which(acts$Activity==activity & acts$Agent==AGENT_ID),]$Intensity, TimeIntensity, type='o', col=i, pch=3)
  }
  i <- i + 1 # increment the colour counter (one colour per activity)
  j<- 1 # Reset the point type counter - same point type for each kind of intensity (total, background, time)
}

legend("topleft", legend=all.acts, col=1:length(all.acts), lty=1, pch="o")
legend("topright", legend=c('Overall','Background','Time'), col=1, lty=1, pch=1:3)

```

Plot the intensities of the different activities, but on different plots.

```{r plotActivitiesMultiplePlots}

# Find the activity with the highest overall intensity. That needs to be plotted first
all.acts <- unique(acts$Activity)

par(mfrow=c(length(all.acts),1))

# Plot
i <- 1 # For colours
for (activity in all.acts) {
  # Plot overall intensity
  plot(x=acts[which(acts$Activity==activity & acts$Agent==AGENT_ID),]$date,
       y=acts[which(acts$Activity==activity & acts$Agent==AGENT_ID),]$Intensity,
       type='o', col=i, ylim=c(0,max(acts$Intensity)), pch=1, xlab = "Time", ylab="Intensity", main=paste("Agent",AGENT_ID,activity) 
       )
  # Backgruound intesity
  points(x=acts[which(acts$Activity==activity & acts$Agent==AGENT_ID),]$date,
         y=acts[which(acts$Activity==activity & acts$Agent==AGENT_ID),]$BackgroundIntensity,
         type='o', col=i, pch=2
         )
  # Time intensity
  points(x=acts[which(acts$Activity==activity & acts$Agent==AGENT_ID),]$date,
         y=acts[which(acts$Activity==activity & acts$Agent==AGENT_ID),]$TimeIntensity, 
         type='o', col=i, pch=3
         )
  legend("topright", legend=c('Overall','Background','Time'), col=1, lty=1, pch=1:3)
    
  i <- i + 1 # increment the colour counter (one colour per activity)
  j<- 1 # Reset the point type counter - same point type for each kind of intensity (total, background, time)
}

#legend("topleft", legend=all.acts, col=1:length(all.acts), lty=1, pch="o")


```




Map the agent locations.

```{r plotAgentLocations }

#agents.coords = cbind(agents$x, agents$y)
#agents.spdf = SpatialPointsDataFrame(agents.coords, agents)

#plot(agents.spdf)

```








