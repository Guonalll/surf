---
title: "surf results analysis"
author: "Nick Malleson"
date: '`r format(Sys.time(), "%d %B, %Y (%H:%M)")`'
output:
  html_document: 
    toc: yes
    pandoc_args: [
      "+RTS", "-K64m",
      "-RTS"
    ]
  pdf_document:
    fig_crop: no
    highlight: kate
    keep_tex: yes
    latex_engine: xelatex
    number_sections: yes
fontsize: 10pt
---

TODO: Look for visualisation ideas here: https://dantalus.github.io/ggplot2Slides/#1
In particular - see if there is a nice way to visualise routine behaviours to check the model is working as expected.

```{r initialise, echo=FALSE, message=FALSE, warning=FALSE}

SCENARIO <- "ABBF-easel" # The name of the scenario to analyse
# The ID of the agent to analyse (graphs of all agents can be difficult to understand). If -1 then do a few at random
AGENT_ID <- -1


# Find the most recent run of that scenario
#scenarios.dir <- paste("~/research_not_syncd/git_projects/surf/abm/surf-abm/results/out/",SCENARIO,"/",sep="")
scenario.dir <- paste("./out/",SCENARIO,"/",sep="") # This is the relative directory of the scenario 
setwd("~/research_not_syncd/git_projects/surf/abm/surf-abm/results/") # This is only required when running directly in R(Studio)
runs <- sort(list.files(scenario.dir)) # All the different runs (directories)
run <- tail(runs, n=1) # Most recent run/scenario
wd <- paste(scenario.dir, run, "/", sep="") # The new working directory
print(paste("Using working directory of most recent model of type",SCENARIO,":",wd))
#setwd(wd)


library(GISTools)
#library(rgeos)    # For things like gIntersects
#library(rgdal)     # For reading shapefiles
#library(raster)    # For creating regular grids
#library(plyr)     # For counting and aggregating
#library(tmap)     # For thematic maps
library(classInt) # Jenks natural breaks
#library(png)      # For loading pngs after they have been written
#library(grid)     # so that they can be embedded in knitted documents
#library(spdep)    # For doing the spatial regression, contiguity matrices, etc.
#library(GWmodel)  # For geographically weighted regression (GWR)
#library(MASS)     # For stepwise regression (stepAIC())
#library(pander)   # For printing tables nicely
#library(MVN)      # For testing for multivariate normality (MVN)
library(RColorBrewer) # For making nice colour themes
#library(rgl)       # For 3D space-time cube
library(plot3D)    # For 3D space-time cube


```

# Results anlysis of scenario `r SCENARIO`, run `r run`

Read the data on the agent locations and the activities of the agents at each timestep


```{r readData}
agents <- read.csv(paste(wd,'agents.csv',sep=""))
acts <- read.csv(paste(wd,'agent-activities.csv',sep=""))

# Make proper time columns. Text format is "2011-01-01T01:10"

agents$date <- strptime(as.character(agents$Time), "%Y-%m-%dT%H:%M")
acts$date <- strptime(as.character(acts$Time), "%Y-%m-%dT%H:%M")
```


Plot just the overall intensities of the different activities for some agents.

```{r plotOverallActivity}

# Find the activity with the highest overall intensity. That needs to be plotted first
all.acts <- unique(acts$Activity)

agent.ids <- c() # The agents to plot

if (AGENT_ID == -1) { # Plot a selection of agents chosen at random
  all.ids <- unique(acts$Agent)
  agent.ids <- sample(all.ids, size=10, replace=FALSE)
} else {
  # Otherwise just plot the one agent
  agent.ids <- c(AGENT_ID)
}


# Plot
for (id in agent.ids) {
  par(mfrow=c(1,1))
  i <- 1 # For colours
  for (activity in all.acts) {
    if (i==1) { # First plot
      # Plot overall intensity
      plot(x=acts[which(acts$Activity==activity & acts$Agent==id),]$date,
           y=acts[which(acts$Activity==activity & acts$Agent==id),]$Intensity, 
           type='o', col=i, 
           ylim=c(0,max(acts$Intensity)), # All charts have same y axis
           #ylim=c(0,max(acts[which(acts$Activity==activity & acts$Agent==id),]$Intensity)), # Y axis different for each agent
           pch=1,
           xlab = "Time", ylab="TotalIntensity", main=paste("Activities for agent",id))
    } else { # Now for the remaining activities
      points(
        x=acts[which(acts$Activity==activity & acts$Agent==id),]$date, 
        y=acts[which(acts$Activity==activity & acts$Agent==id),]$Intensity, type='o', col=i )
    }
    i <- i + 1 # increment the colour counter (one colour per activity)
    j<- 1 # Reset the point type counter - same point type for each kind of intensity (total, background, time)
  }
  
  legend("topleft", legend=all.acts, col=1:length(all.acts), lty=1, pch="o")
}

```


Plot all the intensities of the different activities in one chart.

```{r plotActivitiesInOne}

# Find the activity with the highest overall intensity. That needs to be plotted first
all.acts <- unique(acts$Activity)

for (id in agent.ids) {
  # Plot
  i <- 1 # For colours
  for (activity in all.acts) {
    if (i==1) { # First plot
      # Plot overall intensity
      plot(x=acts[which(acts$Activity==activity & acts$Agent==id),]$date,
           y=acts[which(acts$Activity==activity & acts$Agent==id),]$Intensity,
           type='o', col=i, ylim=c(0,max(acts$Intensity)), pch=1,
           xlab = "Time", ylab="TotalIntensity", main=paste("Intensities for agent",id))
      # Backgruound intesity
      points(
        x=acts[which(acts$Activity==activity & acts$Agent==id),]$date,
        y=acts[which(acts$Activity==activity & acts$Agent==id),]$BackgroundIntensity, 
        type='o', col=i, pch=2)
      # Time intensity
      points(
        x=acts[which(acts$Activity==activity & acts$Agent==id),]$date,
        y=acts[which(acts$Activity==activity & acts$Agent==id),]$TimeIntensity, 
        type='o', col=i, pch=3)
    } else { # Now for the remaining activities
      points(x=acts[which(acts$Activity==activity & acts$Agent==id),]$date,
             y=acts[which(acts$Activity==activity & acts$Agent==id),]$Intensity, type='o', col=i, pch=1)
      points(x=acts[which(acts$Activity==activity & acts$Agent==id),]$date, 
             y=acts[which(acts$Activity==activity & acts$Agent==id),]$BackgroundIntensity, type='o', col=i, pch=2)
      points(x=acts[which(acts$Activity==activity & acts$Agent==id),]$date, 
             y=acts[which(acts$Activity==activity & acts$Agent==id),]$TimeIntensity, type='o', col=i, pch=3)
      
    }
    i <- i + 1 # increment the colour counter (one colour per activity)
    j<- 1 # Reset the point type counter - same point type for each kind of intensity (total, background, time)
  } # for activities
  
  legend("topleft", legend=all.acts, col=1:length(all.acts), lty=1, pch="o")
  legend("topright", legend=c('Overall','Background','Time'), col=1, lty=1, pch=1:3)

} # for agent ids

```

Plot the intensities of the different activities, but on different plots.

```{r plotActivitiesMultiplePlots}

# Find the activity with the highest overall intensity. That needs to be plotted first
all.acts <- unique(acts$Activity)

par(mfrow=c(length(all.acts),1))

for (id in agent.ids) {

  # Plot
  i <- 1 # For colours
  for (activity in all.acts) {
    # Plot overall intensity
    plot(x=acts[which(acts$Activity==activity & acts$Agent==id),]$date,
         y=acts[which(acts$Activity==activity & acts$Agent==id),]$Intensity,
         type='o', col=i, ylim=c(0,max(acts$Intensity)), pch=1, xlab = "Time", ylab="Intensity", main=paste("Agent",id,activity) 
         )
    # Backgruound intesity
    points(x=acts[which(acts$Activity==activity & acts$Agent==id),]$date,
           y=acts[which(acts$Activity==activity & acts$Agent==id),]$BackgroundIntensity,
           type='o', col=i, pch=2
           )
    # Time intensity
    points(x=acts[which(acts$Activity==activity & acts$Agent==id),]$date,
           y=acts[which(acts$Activity==activity & acts$Agent==id),]$TimeIntensity, 
           type='o', col=i, pch=3
           )
    legend("topright", legend=c('Overall','Background','Time'), col=1, lty=1, pch=1:3)
      
    i <- i + 1 # increment the colour counter (one colour per activity)
    j<- 1 # Reset the point type counter - same point type for each kind of intensity (total, background, time)
  }
  
  #legend("topleft", legend=all.acts, col=1:length(all.acts), lty=1, pch="o")
} # for agent ids

```



Map the agent locations in 2D and 3D

```{r plotAgentLocations.2D }

for (id in agent.ids) {

  # Data for the agent in question
  single.agent <- agents[agents$Agent==id,]
  
  single.agent.coords = cbind(single.agent$x, single.agent$y)
  single.agent.spdf = SpatialPointsDataFrame(single.agent.coords, single.agent)
  
  # Shading
  shades <- shading(
      classIntervals(single.agent$Iterations, n = 8, style = 'kmeans')$brks,
      cols=brewer.pal(9,'Reds')
  )
  par(mfrow=c(1,2))
  choropleth(single.agent.spdf, single.agent.spdf$Time, shading = shades)
  plot3D::points3D(x=single.agent$x, y=single.agent$y, z=single.agent$Iterations )
}

```





