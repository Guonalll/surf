---
title: "Map Traces"
author: "Nick Malleson"
date: "13 July 2016"
output:
  html_document: 
    toc: yes
    pandoc_args: [
      "+RTS", "-K64m",
      "-RTS"
    ]
  pdf_document:
    fig_crop: no
    highlight: kate
    keep_tex: yes
    latex_engine: xelatex
    number_sections: yes
fontsize: 10pt
---

Just maps gpx files in the current directory. Useful for comparing different types of routes generated through different types of analysis:

 - original traces (the original GPX data)
 - matched routes (the original data matched to OSM routes)
 - shortest paths (the shortest paths the could be used to do the same route)

```{r initialise, echo=FALSE, message=FALSE, warning=FALSE}
setwd('~/research_not_syncd/git_projects/surf/projects/BreezeRoutes/traces')

library(GISTools)
#library(rgeos)    # For things like gIntersects
library(rgdal)     # For reading shapefiles
#library(raster)    # For creating regular grids or converting from SpatialPixelsDataFrame to raster
#library(plyr)     # For counting and aggregating
#library(tmap)     # For thematic maps
#library(classInt) # Jenks natural breaks
#library(png)      # For loading pngs after they have been written
#library(grid)     # so that they can be embedded in knitted documents
#library(spdep)    # For doing the spatial regression, contiguity matrices, etc.
#library(GWmodel)  # For geographically weighted regression (GWR)
#library(MASS)     # For stepwise regression (stepAIC())
#library(pander)   # For printing tables nicely
#library(MVN)      # For testing for multivariate normality (MVN)
#library(stats)     # For a-spatial aggregatiion (aggregate)
#library(ggplot2)   # For density scatter plot
#library(hexbin)    # For hexagonal density scatter plots in ggplot
#library(gridExtra) # To put two graphs next to each other in ggplot
library(plotKML)   # For reading GPX files
library(OpenStreetMap) # For plotting OSM basemaps
```

# Read and map the file

Find all the 'matched' GPX files in the current directory and display them along with the original.

I use `openmap()` to get the OSM basemap. This is pretty temperamental, it was basically trial and error to find the right combination of commands to make it plot the basemap _and_ points. It's weird that you need to calculate the bounding box around the points in one projection, then transform and use the new Mercator points, but still use the old bounding box! Anyway it just about works.

By the way, the process to construct lines looks horrible but isn't too bad. The functions are:

`SpatialLines(Lines(lapply(list(cbind(lon, lat)), Line), ID="a"))`

From inside out it does:
 - `list(cbind(lon, lat))` - make a list from the iput lon/lat coordinates
 - `lapply( ... , Line)` - pass each coordinate pair to the `Line` constructor to create a Line object. The output from this is a list of Line objects. (_It's annoying that Lines() wont take the list of coordinates, but there you go.._).
 - `Lines( ... , ID="a")` - pass that list of `Line` object and create a single line. The ID is pointless but it complains without it
 - `SpatialLines( ... )` - make it spatial


```{r }
path <- "."
setwd(path)
file.names <- dir(path, pattern ="-matched.gpx")
for(i in seq(length(file.names))){
  f <- file.names[i] # The 'matched' file (e.g. 'f531b5395-matched.gpx')
  f.orig <- paste(substr(f,1, nchar(f)-12),".gpx", sep="") # The orignal file (f531b5395.gpx)
  print(paste("Reading file: ",f))
  # Read the GPX files
  matched <- readGPX(f,   metadata = TRUE, bounds = TRUE,waypoints = FALSE, tracks = TRUE, routes = TRUE)
  orig <- readGPX(f.orig, metadata = TRUE, bounds = TRUE,waypoints = FALSE, tracks = TRUE, routes = TRUE)
  
  # Create SpatialPoints and SpatialLines objects for spatial analysis using lat/lon cooordinate system.
  # (See explanation about how to make SpatialLines in the explanation above).
  #matched.track <- as.data.frame(matched$tracks)
  #matched.sp.latlon <- SpatialPointsDataFrame(coords = cbind(matched.route$NA.lon, matched.route$NA.lat), 
  #                                            data=matched.route, proj4string = CRS("+init=epsg:4326") )
  matched.route <- as.data.frame(matched$routes)
  matched.sp.latlon <- SpatialPointsDataFrame(coords = cbind(matched.route$NA.lon, matched.route$NA.lat), 
                                              data=matched.route, proj4string = CRS("+init=epsg:4326") )
  matched.sp.lines.latlon <- SpatialLines(list(Lines(
    lapply(list(cbind(matched.route$NA.lon, matched.route$NA.lat)), Line), ID="a")),
    proj4string = CRS("+init=epsg:4326"))
  
  orig.track <- as.data.frame(orig$tracks)
  orig.sp.latlon <- SpatialPointsDataFrame(coords = cbind(orig.track$lon, orig.track$lat), 
                                           data=orig.track, proj4string = CRS("+init=epsg:4326") )
  orig.sp.lines.latlon <- SpatialLines(list(Lines(
    lapply(list(cbind(orig.track$lon, orig.track$lat)), Line), ID="a")),
    proj4string = CRS("+init=epsg:4326"))
  
  # Get a bounding box for the whole dataset to make sure plots are big enough
  # Need to do this before projecting otherwise openmap() doesn't work (not sure why)
  bb <- bbox(matched.sp.latlon + orig.sp.latlon)

  # Project to WGS 84 / Pseudo Mercator (epsg:3857) for OSM
  matched.sp.merc <- spTransform(matched.sp.latlon, CRS("+init=epsg:3857"))
  orig.sp.merc    <-   spTransform(orig.sp.latlon,    CRS("+init=epsg:3857"))
  matched.sp.lines.merc <- spTransform(matched.sp.lines.latlon, CRS("+init=epsg:3857"))
  orig.sp.lines.merc <- spTransform(orig.sp.lines.latlon, CRS("+init=epsg:3857"))
  
  # Project the routes to aprojected coordinate system used in MA   (https://www.arcgis.com/home/item.html?id=d075ba0b6b5e4d71b596e882493f7789)
  #matched.sp.ma <- spTransform(matched.sp.latlon, CRS("+init=epsg:5070"))
  #orig.sp.ma <- spTransform(orig.sp.latlon, CRS("+init=epsg:5070"))
  
  # Get an OSM basemap (coordinates are upper-left and lower-right)
  basemap <- openmap(
    upperLeft = c(bb[2,2],bb[1,1]), # Upper-left (lat,lon) (y,x)
    lowerRight = c(bb[2,1], bb[1,2]), # Lower-right
    type='osm', zoom=18)
  #plot(1,1,xlim=c(bb[1,1],bb[1,2]), ylim=c(bb[2,1],bb[2,2]))
  plot(basemap)
  axis(1)
  axis(2)
  plot(orig.sp.merc, col='blue', pch='.', cex=5, add=T)
  plot(orig.sp.lines.merc, col='blue', add=T, lwd=3)
  plot(matched.sp.merc, pch=20, col='black', add=T)
  plot(matched.sp.lines.merc, col='black', add=T, lwd=3)
  
  legend('topleft', legend = c('Original', 'Matched'), pch=c('.',20), col=c('blue','black'))
  
  }


```

